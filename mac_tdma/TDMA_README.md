# TDMA Implementation Notes

This document describes the minimal TDMA (time-division multiple access)
implementation added to the project and how to use/configure it.

**Quick summary**
- Mode: Minimal TDMA that coexists with prior RA (random-access / collision-avoidance).
- Deterministic slot selection: by default `slot_index = short_rd_id % slot_count`.
- Optional: explicit per-association slot assignment.

Files changed
- `src/dect/mac/dect_phy_mac_client.c` — core TDMA scheduling branch added in
  `dect_phy_mac_client_next_rach_tx_time_get()`; association data extended to store
  `assigned_slot`.
- `src/dect/common/dect_common_settings.h` and `src/dect/common/dect_common_settings.c` —
  added `tdma_enabled` and `tdma_slot_count` settings plus defaults.
- `src/dect/dect_phy_shell.c` — exposed settings via CLI: `--tdma_enable` and
  `--tdma_slot_count` and added settings printing.
- `src/dect/mac/dect_phy_mac_common.h` — `struct dect_phy_mac_associate_params`
  extended with `assigned_slot` (-1 = none).
- `src/dect/mac/dect_phy_mac_shell.c` — CLI: `dect mac associate` accepts `-s/--slot`.

Design and behavior

1) TDMA activation
- The TDMA branch is used when `current_settings->tdma_enabled` is true. Otherwise,
  the original RA (collision-avoidance) logic is used unchanged.

2) Slot count
- If `tdma_slot_count` setting is non-zero it is used as the slot count.
- If `tdma_slot_count == 0` the implementation derives slot count from the beacon
  interval: slot_count = floor(beacon_interval_in_mdm_ticks / DECT_RADIO_SLOT_DURATION_IN_MODEM_TICKS).

3) Slot selection
- If an associated entry has an explicit `assigned_slot` (set via `dect mac associate -s N`),
  that slot is used (no hashing).
- Otherwise slot_index = `short_rd_id % slot_count`.

4) TX time calculation
- The chosen slot corresponds to a frame time inside the next beacon interval:
  frame_time = next_beacon_frame_start + slot_index * DECT_RADIO_SLOT_DURATION_IN_MODEM_TICKS
  plus a small offset of `2 * DECT_RADIO_SUBSLOT_DURATION_IN_MODEM_TICKS` to preserve
  the previous RX alignment behavior.
- The code ensures the computed TX time is after modem latency / scheduling delay and
  attempts to avoid colliding with our own beacon TX. If the computed time isn't valid
  (e.g., interval too short, computed time falls outside validity window), the code
  falls back to the original RA calculation (safe fallback).

CLI / Settings

- Toggle TDMA: `dect sett --tdma_enable 1` (enable) or `0` (disable).
- Force slot count: `dect sett --tdma_slot_count <N>` (set N slots; `0` = auto derive).
- Associate with explicit slot: `dect mac associate -t <long_rd_id> -s <slot_index>`
  Example: `dect mac associate -t 1234 -s 3` to request slot 3 for that association.

Notes on explicit slot assignment
- When you pass `--slot` during `associate`, the value is stored in the association
  record and used by the client-side TDMA slot selection logic.
- The implementation does not currently validate that the assigned slot is within the
  automatically derived slot_count; if you want strict validation (and a warning/error),
  we can add checks to either the CLI or association path.

Limitations & next improvements
- This is a minimal, stateless TDMA mapping. If slot_count is small relative to the
  number of clients, collisions can still occur (multiple clients can map to same slot).
- Recommended improvements:
  - Central slot allocation (server announces slot assignments in beacon or association resp).
  - Validation of explicit assignments and optional rejection/warning when out-of-range.
  - Dynamic reallocation and beacon signaling for slot maps.
  - Tests and simulation to measure collisions and timing correctness.

Testing & build

1) Build the project (from workspace root):

```powershell
cmake --build build/tdma --target all
```

2) Commands to exercise flow:
- Start beacon: `dect mac beacon_start` (see existing CLI for options).
- Scan for beacons: `dect mac beacon_scan -c 0` (see existing CLI for options).
- Associate with explicit slot: `dect mac associate -t <long_rd_id> -s <slot_index>`.
- Enable/disable TDMA: `dect sett --tdma_enable 1` / `0`.

Files to review in codebase
- `src/dect/mac/dect_phy_mac_client.c`
- `src/dect/common/dect_common_settings.h`
- `src/dect/common/dect_common_settings.c`
- `src/dect/dect_phy_shell.c`
- `src/dect/mac/dect_phy_mac_common.h`
- `src/dect/mac/dect_phy_mac_shell.c`

If you want, I can:
- Run a build and fix any compile issues.
- Add validation for explicit assigned slots (CLI or association handler).
- Add beacon-side signaling or association response fields to confirm slot allocation.

---
Generated by development work changing MAC behavior to a TDMA-first approach
with optional explicit per-association slot control.
